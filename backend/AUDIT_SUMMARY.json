{
  "auditDate": "2026-01-21",
  "severity": "CRITICAL",
  "productionMigrationReady": false,
  "totalBreakingPoints": 47,
  
  "mongooseOnlyFiles": [
    "routes/orders.js",
    "routes/brands.js",
    "routes/vendor.js",
    "routes/users.js",
    "routes/wishlist.js",
    "routes/vendorVerification.js",
    "routes/stories.js",
    "routes/sellers.js",
    "routes/analytics.js",
    "routes/admin.js",
    "routes/reels.js",
    "routes/roleManagement.js",
    "routes/search.js",
    "routes/smartCollections.js",
    "routes/recommendations.js",
    "routes/promotions.js",
    "controllers/cartController.js",
    "controllers/adminController.js",
    "controllers/orderController.js",
    "controllers/productController.js",
    "controllers/paymentController.js",
    "controllers/contentAPI.js",
    "controllers/authController.js",
    "controllers/categoryController.js",
    "controllers/returnController.js",
    "controllers/inventoryController.js",
    "controllers/userController.js",
    "controllers/rewardController.js",
    "controllers/contentController.js",
    "services/databaseSecurity.js",
    "services/dataProvider.js"
  ],
  
  "failingAdminEndpoints": [
    {
      "endpoint": "GET /admin/roles",
      "file": "routes/admin.js",
      "lineNumber": 482,
      "error": "500",
      "cause": "Role.find() - Role model not wrapped for PostgreSQL",
      "mongooseMethod": "Model.find()",
      "whyFails": "Role model only exists as Mongoose schema, no SQL equivalent",
      "affectedUsers": "Admin users trying to manage roles",
      "priority": "CRITICAL"
    },
    {
      "endpoint": "GET /admin/departments",
      "file": "routes/admin.js",
      "lineNumber": 508,
      "error": "500",
      "cause": "Department.find() - Department model only in MongoDB",
      "mongooseMethod": "Model.find()",
      "whyFails": "Department not defined in models_sql, only in MongoDB",
      "affectedUsers": "Admin users",
      "priority": "CRITICAL"
    },
    {
      "endpoint": "POST /admin/roles",
      "file": "routes/admin.js",
      "lineNumber": 534,
      "error": "500",
      "cause": "new Role() instantiation without save() method",
      "mongooseMethod": "new Model(), Model.save()",
      "whyFails": "PostgreSQL models use .create() not new + .save()",
      "affectedUsers": "Super admins creating roles",
      "priority": "CRITICAL"
    },
    {
      "endpoint": "PUT /admin/roles/:roleId",
      "file": "routes/admin.js",
      "lineNumber": 566,
      "error": "500",
      "cause": "role.save() - SQL models don't have .save()",
      "mongooseMethod": "Document.save()",
      "whyFails": ".save() is Mongoose-only, use .update() for SQL",
      "affectedUsers": "Super admins updating roles",
      "priority": "CRITICAL"
    },
    {
      "endpoint": "DELETE /admin/roles/:roleId",
      "file": "routes/admin.js",
      "lineNumber": 591,
      "error": "500",
      "cause": "role.remove() - SQL uses .destroy()",
      "mongooseMethod": "Document.remove()",
      "whyFails": "Mongoose uses .remove(), Sequelize uses .destroy()",
      "affectedUsers": "Super admins deleting roles",
      "priority": "CRITICAL"
    },
    {
      "endpoint": "GET /admin/permissions",
      "file": "routes/admin.js",
      "lineNumber": 615,
      "error": "500",
      "cause": "Permission.find() - Permission model Mongoose-only",
      "mongooseMethod": "Model.find()",
      "whyFails": "No SQL Permission model defined",
      "affectedUsers": "Admin permission management",
      "priority": "CRITICAL"
    },
    {
      "endpoint": "GET /admin/team",
      "file": "routes/admin.js",
      "lineNumber": 744,
      "error": "500",
      "cause": "User.find() with Mongoose selectors",
      "mongooseMethod": "Model.find(), Model.select(), Model.lean()",
      "whyFails": ".select() and .lean() are Mongoose-only chaining methods",
      "affectedUsers": "Admins viewing team members",
      "priority": "CRITICAL"
    },
    {
      "endpoint": "GET /admin/quick-actions",
      "file": "routes/admin.js",
      "lineNumber": 827,
      "error": "500",
      "cause": "QuickAction.find().lean() - .lean() not on SQL models",
      "mongooseMethod": "Model.find().lean()",
      "whyFails": ".lean() returns plain objects, SQL models already do this",
      "affectedUsers": "Dashboard quick actions",
      "priority": "CRITICAL"
    },
    {
      "endpoint": "GET /admin/analytics",
      "file": "routes/admin.js",
      "lineNumber": 436,
      "error": "500",
      "cause": "Order.aggregate() - MongoDB aggregation pipeline",
      "mongooseMethod": "Model.aggregate()",
      "whyFails": "$match, $group, $sum are MongoDB operators, not SQL",
      "affectedUsers": "Admin analytics dashboard",
      "priority": "CRITICAL"
    },
    {
      "endpoint": "GET /admin/products",
      "file": "routes/admin.js",
      "lineNumber": 912,
      "error": "500",
      "cause": "Product.find().populate().countDocuments()",
      "mongooseMethod": "Model.find().populate().countDocuments()",
      "whyFails": "MongoDB query chain with populate and countDocuments",
      "affectedUsers": "Admins viewing products",
      "priority": "CRITICAL"
    },
    {
      "endpoint": "GET /admin/dashboard/stats",
      "file": "routes/admin.js",
      "lineNumber": 433,
      "error": "500",
      "cause": "getDashboardStatsFromDB falls back to MongoDB",
      "mongooseMethod": "Model.countDocuments(), Model.aggregate()",
      "whyFails": "dataProvider.count/sum don't have proper SQL implementation",
      "affectedUsers": "Admin dashboard",
      "priority": "CRITICAL"
    },
    {
      "endpoint": "GET /admin/users",
      "file": "routes/admin.js",
      "lineNumber": 443,
      "error": "500",
      "cause": "User.find() direct MongoDB call",
      "mongooseMethod": "Model.find().select().sort()",
      "whyFails": ".select() chains are Mongoose-only",
      "affectedUsers": "Admins managing users",
      "priority": "CRITICAL"
    },
    {
      "endpoint": "PUT /admin/users/:id/role",
      "file": "routes/admin.js",
      "lineNumber": 452,
      "error": "500",
      "cause": "User.findById().save() pattern",
      "mongooseMethod": "Model.findById().save()",
      "whyFails": "Mongoose instance method pattern not available in SQL",
      "affectedUsers": "Admins updating user roles",
      "priority": "CRITICAL"
    },
    {
      "endpoint": "PUT /admin/users/:id/status",
      "file": "routes/admin.js",
      "lineNumber": 459,
      "error": "500",
      "cause": "User.findById() with .save()",
      "mongooseMethod": "Model.findById().save()",
      "whyFails": ".findById() + .save() is Mongoose instance pattern",
      "affectedUsers": "Admins toggling user status",
      "priority": "CRITICAL"
    },
    {
      "endpoint": "GET /api/brands",
      "file": "routes/brands.js",
      "lineNumber": 20,
      "error": "501",
      "cause": "Explicitly blocked - requireMongo guard",
      "mongooseMethod": "Model.aggregate()",
      "whyFails": "$group, $match, $sum, $sort are MongoDB-only operators",
      "affectedUsers": "Brand browsing",
      "priority": "CRITICAL"
    },
    {
      "endpoint": "GET /api/analytics/overview",
      "file": "routes/analytics.js",
      "lineNumber": 85,
      "error": "500",
      "cause": "Order.aggregate() not implemented",
      "mongooseMethod": "Model.aggregate()",
      "whyFails": "Complex aggregation with $lookup, $group, $sum",
      "affectedUsers": "Analytics dashboard",
      "priority": "CRITICAL"
    },
    {
      "endpoint": "GET /vendor/dashboard/stats",
      "file": "routes/vendor.js",
      "lineNumber": 14,
      "error": "500",
      "cause": "Order.aggregate() with $lookup",
      "mongooseMethod": "Model.aggregate()",
      "whyFails": "$lookup is MongoDB JOIN, not available in PostgreSQL wrapper",
      "affectedUsers": "Vendor dashboard",
      "priority": "CRITICAL"
    },
    {
      "endpoint": "GET /vendor/products",
      "file": "routes/vendor.js",
      "lineNumber": 155,
      "error": "500",
      "cause": "Product.find().populate()",
      "mongooseMethod": "Model.find().populate()",
      "whyFails": ".populate() is Mongoose reference resolution",
      "affectedUsers": "Vendor product management",
      "priority": "CRITICAL"
    },
    {
      "endpoint": "GET /vendor/orders",
      "file": "routes/vendor.js",
      "lineNumber": 265,
      "error": "500",
      "cause": "Order.find().populate() chains",
      "mongooseMethod": "Model.find().populate().sort().skip().limit()",
      "whyFails": "Complex Mongoose query chain",
      "affectedUsers": "Vendor order management",
      "priority": "CRITICAL"
    },
    {
      "endpoint": "GET /api/orders/my-orders",
      "file": "routes/orders.js",
      "lineNumber": 24,
      "error": "500",
      "cause": "Order.find().populate()",
      "mongooseMethod": "Model.find().populate().sort().skip().limit()",
      "whyFails": "Mongoose query chain not on SQL models",
      "affectedUsers": "Customer order history",
      "priority": "CRITICAL"
    }
  ],
  
  "mongooseAggregationPipelines": {
    "count": 25,
    "files": [
      {
        "file": "routes/brands.js",
        "instances": [
          {"line": 20, "operators": ["$match", "$group", "$sum", "$avg", "$min", "$max", "$sort"]},
          {"line": 64, "operators": ["$match", "$group", "$sum", "$avg", "$totalViews", "$totalLikes", "$sort", "$limit"]},
          {"line": 109, "operators": ["$match", "$group", "$avg", "$min", "$max"]},
          {"line": 133, "operators": ["$match", "$group", "$sort"]}
        ]
      },
      {
        "file": "routes/vendor.js",
        "instances": [
          {"line": 30, "operators": ["$lookup", "$match", "$group", "$sum"]},
          {"line": 89, "operators": ["$lookup", "$match", "$group", "$sum", "$sort"]},
          {"line": 110, "operators": ["multiple $lookup", "$group"]}
        ]
      },
      {
        "file": "routes/analytics.js",
        "instances": [
          {"line": 85, "operators": ["$lookup", "$match", "$group", "$sum"]},
          {"line": 96, "operators": ["$match", "$group", "$sum"]},
          {"line": 166, "operators": ["$lookup", "$match", "$group"]},
          {"line": 180, "operators": ["$match", "$group"]},
          {"line": 209, "operators": ["$match", "$group"]}
        ]
      },
      {
        "file": "routes/vendorVerification.js",
        "instances": [
          {"line": 238, "operators": ["$match", "$group"]}
        ]
      },
      {
        "file": "controllers/productController.js",
        "instances": [
          {"line": 448, "operators": ["$match", "$group"]}
        ]
      },
      {
        "file": "controllers/paymentController.js",
        "instances": [
          {"line": 282, "operators": ["$match", "$group", "$sum"]}
        ]
      },
      {
        "file": "controllers/rewardController.js",
        "instances": [
          {"line": 183, "operators": ["$match", "$group", "$sort", "$limit"]},
          {"line": 252, "operators": ["$group", "$sum"]},
          {"line": 265, "operators": ["$group", "$sum"]}
        ]
      },
      {
        "file": "controllers/userController.js",
        "instances": [
          {"line": 360, "operators": ["$match", "$group"]},
          {"line": 455, "operators": ["$match", "$group"]}
        ]
      }
    ]
  },
  
  "populateChainUsage": {
    "count": 40,
    "files": [
      "routes/users.js",
      "routes/wishlist.js",
      "routes/vendor.js",
      "routes/stories.js",
      "routes/reels.js",
      "routes/roleManagement.js",
      "routes/recommendations.js",
      "routes/vendorVerification.js",
      "controllers/cartController.js",
      "controllers/orderController.js",
      "controllers/productController.js",
      "controllers/returnController.js",
      "controllers/paymentController.js",
      "controllers/contentController.js",
      "controllers/inventoryController.js"
    ],
    "issue": ".populate() is Mongoose reference resolution - need .include() for Sequelize"
  },
  
  "mongoDbOnlyOperators": {
    "count": 50,
    "operators": ["$regex", "$in", "$gte", "$lte", "$lt", "$gt", "$or", "$and", "$lookup", "$match", "$group", "$sum", "$avg", "$min", "$max", "$sort", "$skip", "$limit"],
    "files": [
      "routes/search.js",
      "routes/roleManagement.js",
      "routes/stories.js",
      "routes/vendor.js",
      "routes/sellers.js"
    ]
  },
  
  "missingPostgresModels": [
    "Banner",
    "Campaign",
    "Coupon",
    "Courier",
    "FAQ",
    "FlashSale",
    "InventoryAlert",
    "InventoryHistory",
    "KYCDocument",
    "Page",
    "Promotion",
    "Return",
    "Reel",
    "SearchHistory",
    "SellerCommission",
    "SellerPerformance",
    "Shipment",
    "ShippingCharge",
    "StyleInspiration",
    "Ticket",
    "Transaction"
  ],
  
  "missingForeignKeyRelations": [
    {
      "relation": "Order → OrderItems → Product",
      "mongoDbStyle": "items: [{productId, quantity}]",
      "postgresRequired": "orders_items table with order_id, product_id FK",
      "status": "BROKEN"
    },
    {
      "relation": "Story → Story.products[]",
      "mongoDbStyle": "products: [ObjectId]",
      "postgresRequired": "story_products junction table",
      "status": "BROKEN"
    },
    {
      "relation": "User → followers/following",
      "mongoDbStyle": "followers: [ObjectId], following: [ObjectId]",
      "postgresRequired": "user_followers junction table",
      "status": "BROKEN"
    },
    {
      "relation": "Product → reviews[]",
      "mongoDbStyle": "reviews: [{userId, rating, text}]",
      "postgresRequired": "product_reviews table",
      "status": "BROKEN"
    },
    {
      "relation": "Reel → products[]",
      "mongoDbStyle": "products: [ObjectId]",
      "postgresRequired": "reel_products junction table",
      "status": "BROKEN"
    },
    {
      "relation": "Cart → items[]",
      "mongoDbStyle": "items: [{productId, quantity}]",
      "postgresRequired": "cart_items table",
      "status": "BROKEN"
    },
    {
      "relation": "Wishlist → items[]",
      "mongoDbStyle": "items: [{productId}]",
      "postgresRequired": "wishlist_items table",
      "status": "BROKEN"
    }
  ],
  
  "controllersWithDirectDbAccess": [
    "controllers/cartController.js",
    "controllers/adminController.js",
    "controllers/orderController.js",
    "controllers/productController.js",
    "controllers/paymentController.js",
    "controllers/contentAPI.js",
    "controllers/authController.js",
    "controllers/categoryController.js",
    "controllers/returnController.js",
    "controllers/inventoryController.js",
    "controllers/userController.js",
    "controllers/rewardController.js"
  ],
  
  "recommendedRepositories": [
    "BrandRepository",
    "OrderRepository (partial - exists but incomplete)",
    "ProductRepository",
    "UserRepository",
    "VendorRepository",
    "RoleRepository",
    "AuditLogRepository",
    "CouponRepository",
    "ReturnRepository",
    "ShipmentRepository",
    "AnalyticsRepository",
    "CartRepository",
    "WishlistRepository",
    "PaymentRepository"
  ],
  
  "statistics": {
    "totalBreakingPoints": 47,
    "routesWithMongoCoupling": 15,
    "controllersWithDirectDbAccess": 12,
    "aggregatePipelinesCount": 25,
    "populateCallsCount": 40,
    "mongoDbOperatorsCount": 50,
    "missingPostgresModelsCount": 21,
    "missingForeignKeysCount": 7,
    "brokenAdminEndpointsCount": 15,
    "filesRequiringRefactoring": 31,
    "estimatedLinesOfCodeToRewrite": 3000
  },
  
  "riskAssessment": {
    "severity": "CRITICAL",
    "productionOutagePercentage": "60%+",
    "affectedFeatures": [
      "Admin functionality (100%)",
      "Brand management (100%)",
      "Analytics (100%)",
      "Vendor dashboard (100%)",
      "Role management (100%)",
      "Social features (100%)",
      "Order management (80%)",
      "User management (80%)",
      "Payment processing (70%)"
    ],
    "recommendation": "DO NOT MIGRATE TO POSTGRESQL WITHOUT FIXING THESE ISSUES"
  },
  
  "migrationPhases": {
    "phase1_critical": {
      "duration": "Week 1-2",
      "tasks": [
        "Create missing 20+ PostgreSQL models",
        "Implement all missing tables and foreign keys",
        "Create universal Repository layer for all models",
        "Migrate admin endpoints to use repositories"
      ]
    },
    "phase2_high": {
      "duration": "Week 3-4",
      "tasks": [
        "Replace all .aggregate() calls with SQL equivalents",
        "Replace all .populate() with .include()",
        "Create SQL aggregation utilities"
      ]
    },
    "phase3_medium": {
      "duration": "Week 5",
      "tasks": [
        "Refactor controllers to use repositories",
        "Remove direct model imports from routes",
        "Implement query abstraction layer"
      ]
    },
    "phase4_low": {
      "duration": "Week 6+",
      "tasks": [
        "Remove MongoDB-specific code paths",
        "Deprecate Mongoose models",
        "Clean up adapter code"
      ]
    }
  }
}
